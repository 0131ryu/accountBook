{% extends 'layout.html' %}
{% block content %}

<main>
    <div class="inner">
        <div class="jumbotron-container">
            <div class="jumbotron-item-main">
                <div class="jumbotron-item-main-message">
                    <p>Îß§ÏùºÎß§Ïùº ÏåìÏïÑÍ∞ÄÎäî,</p>
                    <h2>ÏòÅÎã®Ïñ¥ Ïô∏Ïö∞Í∏∞</h2>
                </div>
                <div class="jumbotron-item-main-image"></div>
            </div>
            <!-- jumbotron-item-main -->
            <div class="jumbotron-item-sub">
                <p>ÏûäÏñ¥ Î≤ÑÎ¶¨Í∏∞ Ïâ¨Ïö¥ ÏòÅÎã®Ïñ¥Î•º </p>
                <p><span>Easy, Middle, Advance</span>Î°ú Î∂ÑÎ•òÌï¥ÏÑú Ïô∏ÏõåÎ¥ÖÏãúÎã§</p>
            </div>
            <div class="word-finding">
                {% if user and user.id %}
                <input id="english" type="text" class="word-find-eng" placeholder="Í≤ÄÏÉâÌï† ÏòÅÏñ¥Îã®Ïñ¥ ÏûÖÎ†•" name="english">
                <button class="word-find-eng-btn" id="matrix-input-btn" onClick=`${getSearchWord(event)}`
                    data-id="{{user.id}}">Í≤ÄÏÉâ</button>
                {% endif %}
                <div class="word-find-result">[Í≤∞Í≥ºÍ∞í]
                    ÏòÅÎã®Ïñ¥ : <span class="word-find-result-eng"></span>
                    ÌïúÍ∏Ä : <span class="word-find-result-kor"></span> Ï¢ÖÎ•ò : <span class="word-find-result-type"></span>
                </div>
            </div>
        </div>
        <!-- jumbotron-container -->
        <div class="word-counting">
            <p>Ïô∏Ïö¥ Îã®Ïñ¥ Ïàò :
                {% if counting %}
                <span id="word-counting-checked">{{counting}}
                    {% else %}
                    <span id="word-counting-checked">0
                        {% endif %}
                    </span>
            </p>
            <p>Ï¥ù Îã®Ïñ¥ Ïàò :
                {% if total %}
                <span id="word-counting-all">{{total}}
                    {% else %}
                    <span id="word-counting-all">0
                        {% endif %}
                    </span>
            </p>

        </div>
        <!-- {% if words %} -->
        <div class="matrix-container">
            <div class="check_all">
                <input type="checkbox" class="word-status" id="checkboxStatus" name="countCheckbox" data-id=0 /> <label
                    for="checkAll">Î™®Îì† Ï≤¥ÌÅ¨Î∞ïÏä§
                    Ï≤¥ÌÅ¨</label>
            </div>
            <div class="matrix-item">
                <div class="matrix-item-header">
                    <div class="matrix-title">ü•â Easy </div>
                    <input id="english" type="text" placeholder="ÏòÅÏñ¥ ÏûÖÎ†•" name="english" class="english-easy">
                    <input id="korean" type="text" placeholder="ÌïúÍ∏Ä ÏûÖÎ†•" name="korean" class="korean-easy">
                    <input id="checkboxs" type="checkbox" name="type" value="easy" checked>
                    <button class="matrix-input-btn-easy" id="matrix-input-btn" onClick=`${getAddWordEasy(event)}`
                        data-type="easy">Îì±Î°ùÌïòÍ∏∞</button>
                </div>

                <!-- matrix-item-header -->
                <ul class="matrix-item-list">
                    {% if user and user.id %}
                    {% for word in wordsEasy %}
                    {% if user.id === word.UserId %}
                    <li class="list-item" id="${word.wordIdx}">
                        <div class="done-text-container">
                            {% if word.status === "C" %}
                            <div class="check_item">
                                <input type="checkbox" class="word-status" id="checkboxStatus" name="countCheckbox"
                                    onClick=`${getStatusCheck(event)}` data-id="{{word.id}}" checked />
                                <label for="checkitem"></label>
                            </div>
                            {% else %}
                            <div class="check_item">
                                <input type="checkbox" class="word-status" id="checkboxStatus" name="countCheckbox"
                                    onClick=`${getStatusCheck(event)}` data-id="{{word.id}}" />
                                <label for="checkitem"></label>
                            </div>
                            {% endif %}
                            <p class="word-text-eng">{{word.english}}</p>
                        </div>
                        <div class="done-text-container">
                            <p class="word-text-kor">{{word.korean}}</p>
                        </div>
                        <div class="update-delete-container">
                            <i id="word-update" class="word-update fa-solid fa-pencil" data-id="{{word.id}}"
                                onClick=`${getChangeWord(event)}`></i>
                            <i class="word-status fa-solid fa-trash-can" data-id="{{word.id}}"
                                onClick=`${getStatus(event)}` id="D"></i>
                        </div>
                    </li>
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                </ul>
            </div>
            <div class="matrix-item" id="middle">
                <div class="matrix-item-header">
                    <div class="matrix-title">ü•à Middle </div>
                    <input id="english" type="text" placeholder="ÏòÅÏñ¥ ÏûÖÎ†•" name="english" class="english-middle">
                    <input id="korean" type="text" placeholder="ÌïúÍ∏Ä ÏûÖÎ†•" name="korean" class="korean-middle">
                    <input id="checkboxs" type="checkbox" name="type" value="middle" checked>
                    <button class="matrix-input-btn-easy" id="matrix-input-btn" onClick=`${getAddWordMiddle(event)}`
                        data-type="middle">Îì±Î°ùÌïòÍ∏∞</button>
                </div>

                <!-- matrix-item-header -->
                <ul class="matrix-item-list">
                    {% if user and user.id %}
                    {% for word in wordsMiddle %}
                    {% if user.id === word.UserId %}
                    <li class="list-item" id="${word.wordIdx}">
                        <div class="done-text-container">
                            {% if word.status === "C" %}
                            <div class="check_item">
                                <input type="checkbox" class="word-status" id="checkboxStatus" name="countCheckbox"
                                    onClick=`${getStatusCheck(event)}` data-id="{{word.id}}" checked />
                                <label for="checkitem"></label>
                            </div>
                            {% else %}
                            <div class="check_item">
                                <input type="checkbox" class="word-status" id="checkboxStatus" name="countCheckbox"
                                    onClick=`${getStatusCheck(event)}` data-id="{{word.id}}" />
                                <label for="checkitem"></label>
                            </div>
                            {% endif %}
                            <p class="word-text-eng">{{word.english}}</p>
                        </div>
                        <div class="done-text-container">
                            <p class="word-text-kor">{{word.korean}}</p>
                        </div>
                        <div class="update-delete-container">
                            <i id="word-update" class="word-update fa-solid fa-pencil" data-id="{{word.id}}"
                                onClick=`${getChangeWord(event)}`></i>
                            <i class="word-status fa-solid fa-trash-can" data-id="{{word.id}}"
                                onClick=`${getStatus(event)}` id="D"></i>
                        </div>
                    </li>
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                </ul>
            </div>
            <!-- matrix-item do -->
            <div class="matrix-item" id="advance">
                <div class="matrix-item-header">
                    <div class="matrix-title">ü•á Advance </div>
                    <input id="english" type="text" placeholder="ÏòÅÏñ¥ ÏûÖÎ†•" name="english" class="english-advance">
                    <input id="korean" type="text" placeholder="ÌïúÍ∏Ä ÏûÖÎ†•" name="korean" class="korean-advance">
                    <input id="checkboxs" type="checkbox" name="type" value="advance" checked>
                    <button class="matrix-input-btn-easy" id="matrix-input-btn" onClick=`${getAddWordAdvance(event)}`
                        data-type="advance">Îì±Î°ùÌïòÍ∏∞</button>
                </div>
                <!-- matrix-item-header -->
                <ul class="matrix-item-list">
                    {% if user and user.id %}
                    {% for word in wordsAdvance %}
                    {% if user.id === word.UserId %}
                    <li class="list-item" id="${word.wordIdx}">
                        <div class="done-text-container">
                            {% if word.status === "C" %}
                            <div class="check_item">
                                <input type="checkbox" class="word-status" id="checkboxStatus" name="countCheckbox"
                                    onClick=`${getStatusCheck(event)}` data-id="{{word.id}}" checked />
                                <label for="checkitem"></label>
                            </div>
                            {% else %}
                            <div class="check_item">
                                <input type="checkbox" class="word-status" id="checkboxStatus" name="countCheckbox"
                                    onClick=`${getStatusCheck(event)}` data-id="{{word.id}}" />
                                <label for="checkitem"></label>
                            </div>
                            {% endif %}
                            <p class="word-text-eng">{{word.english}}</p>
                        </div>
                        <div class="done-text-container">
                            <p class="word-text-kor">{{word.korean}}</p>
                        </div>
                        <div class="update-delete-container">
                            <i id="word-update" class="word-update fa-solid fa-pencil" data-id="{{word.id}}"
                                onClick=`${getChangeWord(event)}`></i>
                            <i class="word-status fa-solid fa-trash-can" data-id="{{word.id}}"
                                onClick=`${getStatus(event)}` id="D"></i>
                        </div>
                    </li>
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                </ul>
            </div>
            <div class="deleted-items">
                <div class="deleted-item-list">
                    <button class="deletedWord-btn" data-status="D" onClick=`${getStatusD(event)}`>ÏÇ≠Ï†úÌïú Îã®Ïñ¥ ÌôïÏù∏ÌïòÍ∏∞</button>
                    <div class="deletedItems" name="deletedItems">
                        {% for word in deletedWord %}
                        <li class="deletedWords-result" id="${word.wordIdx}">
                            <div class="done-text-container">
                                <p class="word-id" id="{{word.id}}">[{{word.type}}]</p>
                                <p class="word-text-eng">{{word.english}}</p>
                                <p class="word-text-kor">{{word.korean}}</p>
                            </div>
                            <div class="update-delete-container">
                                <i class="word-deleted-change fa fa-refresh" data-id="{{word.id}}"
                                    data-status="{{word.status}}" onClick=`${getStatusA(event)}`></i>
                                <i class="word-deleted-done fa-solid fa-trash-can" data-id="{{word.id}}"
                                    onClick=`${getDelete(event)}`></i>
                            </div>
                        </li>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <!-- {% endif %} -->
    </div>
</main>
{% endblock %}

{% block script %}
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
    window.onload = () => {
        if (new URL(location.href).searchParams.get('loginError')) {
            alert(new URL(location.href).searchParams.get('loginError'));
        }
    };

    function validWords(english, korean, type) {
        const validEnglish = /^[a-zA-Z\s]+$/;
        const validKorean = /^[Í∞Ä-Ìû£\s]+$/; //ÎùÑÏñ¥Ïì∞Í∏∞ Ìè¨Ìï®
        const validTypes = ["easy", "middle", "advance"];

        if (!english || !korean) {
            alert("ÏòÅÏñ¥, ÌïúÍ∏ÄÏùÑ Í∞ÅÍ∞Å ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî");
            return false;
        }

        if (!validEnglish.test(english) || !validKorean.test(korean)) {
            alert("englishÏóêÎäî ÏòÅÏñ¥Î°úÎßå, koreanÏùÄ ÌïúÍ∏ÄÎßå ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî");
            return false;
        }

        if (!validTypes.includes(type)) {
            alert("ÏÉùÏÑ± Ïãú ÌïÑÏöîÌïú typeÏóê Î¨∏Ï†úÍ∞Ä ÏûàÏäµÎãàÎã§. ÌôïÏù∏ Î∂ÄÌÉÅÎìúÎ¶ΩÎãàÎã§.");
            return false;
        }
    }

    async function getAddWord(english, korean, type) {
        try {
            await axios.post(`/word/write`, { english, korean, type });
            window.location.reload();
        } catch (err) {
            console.error(err);
        }
    }

    //word ÏÉùÏÑ±(Îπà Í∞íÏùº ÎïåÎèÑ Í∞íÏù¥ ÏûÖÎ†•Îê®)
    function getAddWordEasy(event) {
        const english = document.querySelector(".english-easy").value;
        const korean = document.querySelector(".korean-easy").value;
        console.log("english", english, "korean", korean);
        const type = event.target.dataset.type;

        validWords(english, korean, type);
        getAddWord(english, korean, type);
    }

    function getAddWordMiddle(event) {
        const english = document.querySelector(".english-middle").value;
        const korean = document.querySelector(".korean-middle").value;
        console.log("english", english, "korean", korean);
        const type = event.target.dataset.type;

        validWords(english, korean, type);
        getAddWord(english, korean, type);
    }

    function getAddWordAdvance(event) {
        const english = document.querySelector(".english-advance").value;
        const korean = document.querySelector(".korean-advance").value;
        console.log("english", english, "korean", korean);
        const type = event.target.dataset.type;

        validWords(english, korean, type);
        getAddWord(english, korean, type);
    }


    //word ÏàòÏ†ï
    async function getChangeWord(event) {

        const english = prompt("ÏàòÏ†ïÌï† ÏòÅÏñ¥Îã®Ïñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî");
        const korean = prompt("ÏàòÏ†ïÌï† Îã®Ïñ¥ ÎúªÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî");
        const type = prompt("ÏàòÏ†ïÌï† ÌÉÄÏûÖ(easy, middle, advance)ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî");
        const id = event.target.dataset.id;
        console.log("id", event.target.dataset.id);
        event.preventDefault();

        validWords(english, korean, type);

        if (!type) {
            alert("ÏàòÏ†ïÌï† ÌÉÄÏûÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî");
            return false;
        }

        try {
            await axios.put(`/word/${id}`, { english, korean, type });
            window.location.reload();
        } catch (err) {
            console.error(err);
        }
        english.value = '';
        korean.value = '';
    }

    //status ÏàòÏ†ï(A, C, D)
    async function getStatus(event) {
        let status = "";

        if (event.target.closest(".word-status").id === "A") {
            status = "A"
        } else if (event.target.closest(".word-status").id === "D") {
            let result = confirm("Ï†ïÎßêÎ°ú Îã®Ïñ¥Î•º ÏÇ≠Ï†ú ÌïòÏãúÍ≤†ÏäµÎãàÍπå?");
            if (result === true) {
                alert("ÌôïÏù∏ÏùÑ ÎàåÎ†ÄÏäµÎãàÎã§.");
                status = "D";
            } else {
                alert("Ï∑®ÏÜåÎ•º ÎàåÎ†ÄÏäµÎãàÎã§.");
                status = "A";
            }
        }

        const wordId = event.target.dataset.id;
        console.log("id", event.target.dataset.id);
        console.log("status", event.target.closest(".word-status").id);
        console.log("final status", status);

        event.preventDefault();

        try {
            await axios.patch(`/word/${wordId}`, { status: status });
            location.reload();
        } catch (err) {
            console.error(err);
        }
    }

    //ÏàòÏ†ï - Ï≤¥ÌÅ¨Î∞ïÏä§
    const checkboxes = document.querySelectorAll(".check_item input");
    const checkAll = document.querySelector(".check_all input");

    const agree = {
        checkitem: false
    }

    checkboxes.forEach((item) => item.addEventListener("input", toggleCheckbox));

    async function toggleCheckbox(event) {
        const { checked, id } = event.target;
        agree[id] = checked;
        this.parentNode.classList.toggle("active");
        checkAllStatus();

        const status = event.target.checked ? "C" : "A";
        const wordId = event.target.dataset.id;
        console.log("id", event.target.dataset.id);
        console.log("status", status);

        try {
            await axios.patch(`/word/${wordId}`, { status: status });
            window.location.reload();
        } catch (err) {
            console.error(err);
        }

    }
    function checkAllStatus() {
        const { checkitem } = agree;
        if (checkitem) {
            checkAll.checked = true;
        } else {
            checkAll.checked = false;
        }
    }

    checkAll.addEventListener("click", (event) => {
        const { checked } = event.target;
        if (checked) {
            checkboxes.forEach((item) => {
                item.checked = true;
                agree[item.id] = true;
                item.parentNode.classList.add("active");
            })
        } else {
            checkboxes.forEach((item) => {
                item.checked = false;
                agree[item.id] = false;
                item.parentNode.classList.remove("active");
            })
        }
        const status = event.target.checked ? "C" : "A";
        const wordId = event.target.dataset.id;
        console.log("id", event.target.dataset.id);
        console.log("status", status);


        try {
            axios.patch(`/word/status/1`, { status: status });

            setTimeout(() => {
                window.location.reload();
            }, (500));

        } catch (err) {
            console.error(err);
        }
    })

    async function getSearchWord(event) {
        const english = document.querySelector(".word-find-eng").value;
        const id = event.target.dataset.id;
        console.log("id", id);

        const validEnglish = /^[a-zA-Z\s]+$/;

        if (!validEnglish.test(english)) {
            alert("Ï∞æÏúºÎ†§Îäî Îã®Ïñ¥Îäî ÏòÅÏñ¥Îßå ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
            return false;
        }

        try {
            const result = await axios.get(`/word/${id}/${english}`, { english: english, id: id })
                .then(res => {
                    console.log("res", res.data)
                    console.log("type", res.data.type);
                    console.log("ÌïúÍ∏Ä", res.data.korean);

                    const $resultInfo = document.querySelector(".word-find-result");
                    console.log("$resultInfo", $resultInfo)
                    $resultInfo.style.visibility = "visible";

                    const wordInfo = res.data;

                    const findEnglish = wordInfo.english;
                    const findKorean = wordInfo.korean;
                    const findType = wordInfo.type;

                    const resultEnglish = document.querySelector(".word-find-result-eng");
                    const resultKorean = document.querySelector(".word-find-result-kor");
                    const resultType = document.querySelector(".word-find-result-type");
                    resultEnglish.innerHTML = `${findEnglish}`;
                    resultKorean.innerHTML = `${findKorean}`;
                    resultType.innerHTML = `${findType}`;

                })
                .catch(error => {
                    alert("Ï∞æÏúºÎ†§Îäî Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§.");
                    const $resultInfo = document.querySelector(".word-find-result");
                    console.log("$resultInfo", $resultInfo)
                    $resultInfo.style.visibility = "hidden";
                    console.log(error.res);
                });
        } catch (err) {
            console.error(err);
        }
    }

    function getStatusD(event) {
        const deletedWords = document.querySelector('.deletedItems');
        deletedWords.toggleAttribute("hidden")
    }

    async function getStatusA(event) {
        let status = event.target.dataset.status;
        const wordId = event.target.dataset.id;
        console.log("id", wordId);
        console.log(status);

        let result = confirm("Îã®Ïñ¥Î•º Î≥µÍµ¨ÌïòÏãúÍ≤†ÏäµÎãàÍπå?");
        if (result === true) {
            alert("ÌôïÏù∏ÏùÑ ÎàåÎ†ÄÏäµÎãàÎã§.");
            status = "A";
            console.log("status", status);
        } else {
            alert("Ï∑®ÏÜåÎ•º ÎàåÎ†ÄÏäµÎãàÎã§.");
            status = "D";
            console.log("status", status);
        }

        try {
            await axios.patch(`/word/${wordId}`, { status: status });
            location.reload();
        } catch (err) {
            console.error(err);
        }
    }

    async function getDelete(event) {
        const id = event.target.dataset.id;
        console.log("id", id);
        try {
            if (confirm("[ÏµúÏ¢ÖÏÇ≠Ï†ú] ÏÇ≠Ï†ú ÌõÑ ÏÉàÎ°ú ÏÉùÏÑ±Ìï¥Ïïº Ìï©ÎãàÎã§.")) {
                await axios.delete(`/word/${id}`).then(() => {
                    location.reload();
                }).catch((err) => {
                    console.error(err);
                })
            }
        } catch (err) {
            console.error(err);
        }
    }
</script>
{% endblock %}